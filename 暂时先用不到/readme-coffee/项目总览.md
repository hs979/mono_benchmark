# Serverlesspresso 单体应用 - 项目总览

## 🎉 转换完成！

AWS Serverless应用已成功转换为传统单体应用架构。

## 📁 项目结构

```
monolith-app/
│
├── app.js                    # 应用主入口（Express服务器）
├── package.json              # 项目依赖配置
├── test-workflow.js         # 自动化测试脚本
│
├── services/                 # 业务服务模块
│   ├── database.js          # 内存数据库服务
│   ├── validator.js         # QR码验证服务
│   ├── orderManager.js      # 订单管理服务
│   ├── orderProcessor.js    # 订单处理工作流
│   ├── config.js            # 配置管理服务
│   ├── publisher.js         # 事件发布服务
│   ├── counting.js          # 订单号计数服务
│   ├── orderJourney.js      # 订单旅程服务
│   └── metrics.js           # 指标统计服务
│
└── 文档/
    ├── README.md            # 完整使用文档
    ├── QUICKSTART.md        # 快速入门指南
    ├── 转换说明.md          # 架构转换说明
    └── 项目总览.md          # 本文档
```

## ⚡ 快速开始

### 1. 安装依赖
```bash
cd monolith-app
npm install
```

### 2. 启动应用
```bash
npm start
```

### 3. 运行测试
在另一个终端：
```bash
npm test
```

## 🔧 核心功能

### ✅ 已实现的功能

| 功能模块 | 描述 | 状态 |
|---------|------|------|
| QR码生成 | 管理员生成QR码供客户扫描 | ✅ 完成 |
| QR码验证 | 验证QR码并创建订单 | ✅ 完成 |
| 订单创建 | 客户创建新订单 | ✅ 完成 |
| 订单提交 | 客户提交饮品详情 | ✅ 完成 |
| 订单查询 | 按状态、用户查询订单 | ✅ 完成 |
| 订单认领 | 咖啡师认领待处理订单 | ✅ 完成 |
| 订单完成 | 咖啡师完成订单 | ✅ 完成 |
| 订单取消 | 取消订单 | ✅ 完成 |
| 订单超时 | 自动超时处理（客户5分钟，咖啡师15分钟） | ✅ 完成 |
| 配置管理 | 菜单和商店状态管理 | ✅ 完成 |
| 事件系统 | 服务间事件通信 | ✅ 完成 |
| 容量控制 | 最大并发订单限制 | ✅ 完成 |
| 订单验证 | 饮品和修饰符验证 | ✅ 完成 |
| 订单旅程 | 记录和展示订单完整历程 | ✅ 完成 |
| 业务指标 | 订单、饮品、修饰符统计 | ✅ 完成 |

## 📊 服务端点

### 验证器服务
- `GET /qr-code` - 生成QR码
- `POST /qr-code` - 验证QR码并创建订单

### 订单管理服务
- `GET /orders` - 获取订单列表
- `GET /myOrders` - 获取我的订单
- `GET /orders/:id` - 获取订单详情
- `PUT /orders/:id` - 更新订单（提交/认领/完成/取消）

### 配置服务
- `GET /config` - 获取配置
- `PUT /config` - 更新配置
- `GET /config/all` - 获取所有配置

### 订单旅程服务
- `GET /order-journey/:orderId` - 获取订单旅程
- `GET /order-journey/:orderId/html` - 获取订单旅程HTML
- `GET /order-journey/stats` - 获取订单统计

### 指标服务
- `GET /metrics` - 获取所有指标
- `GET /metrics/orders` - 获取订单指标
- `GET /metrics/drinks` - 获取饮品指标
- `GET /metrics/modifiers` - 获取修饰符指标
- `GET /metrics/report` - 生成指标报告
- `POST /metrics/reset` - 重置指标

## 🎯 核心服务说明

### 1. 验证器服务 (validator.js)
负责QR码的生成和验证，实现时间桶机制和令牌管理。

**关键功能**：
- 生成基于时间桶的QR码
- 验证QR码有效性
- 管理令牌计数
- 触发新订单事件

### 2. 订单管理服务 (orderManager.js)
负责订单的CRUD操作和状态管理。

**关键功能**：
- 订单查询（按状态、用户）
- 订单提交和验证
- 咖啡师认领/取消认领
- 订单完成/取消

### 3. 订单处理服务 (orderProcessor.js)
实现订单处理工作流，替代原Step Functions。

**关键功能**：
- 商店状态检查
- 容量控制
- 订单号生成
- 超时管理
- 工作流状态跟踪

### 4. 配置服务 (config.js)
管理应用配置，包括菜单和商店状态。

**关键功能**：
- 配置读取
- 配置更新
- 配置变更事件

### 5. 数据库服务 (database.js)
提供内存数据存储，替代DynamoDB。

**关键功能**：
- 数据CRUD操作
- 索引查询
- 计数器递增
- 表扫描

### 6. 发布服务 (publisher.js)
处理事件发布，替代IoT Core。

**关键功能**：
- 事件监听
- 日志输出
- 事件通知（可扩展为WebSocket）

### 7. 订单旅程服务 (orderJourney.js)
记录订单的完整生命周期，生成可视化展示。

**关键功能**：
- 记录所有订单事件
- 生成订单旅程HTML页面
- 订单统计和分析
- 事件时间线展示

### 8. 指标服务 (metrics.js)
收集和分析业务指标数据。

**关键功能**：
- 订单统计（开始、完成、取消、超时）
- 饮品销量统计
- 修饰符使用统计
- 完成率、取消率分析
- 指标报告生成

## 🔄 完整订单流程

```
1. 管理员生成QR码
   ↓
2. 客户扫描QR码
   ↓
3. 系统创建订单（状态：CREATED）
   ↓
4. 系统检查商店状态和容量
   ↓
5. 系统启动订单工作流
   ↓
6. 客户提交饮品详情
   ↓
7. 系统生成订单号
   ↓
8. 咖啡师查看待处理订单
   ↓
9. 咖啡师认领订单
   ↓
10. 咖啡师制作饮品
   ↓
11. 咖啡师完成订单（状态：COMPLETED）
   ↓
12. 系统完成工作流
```

## 📝 示例用法

### 完整工作流示例

```bash
# 1. 生成QR码
curl "http://localhost:3000/qr-code?eventId=ABC&admin=true"
# 返回: {"qrCode": "ABC123XYZ", ...}

# 2. 验证QR码创建订单
curl -X POST "http://localhost:3000/qr-code?eventId=ABC&token=ABC123XYZ&userId=customer1"
# 返回: {"orderId": "order123", ...}

# 3. 提交订单详情
curl -X PUT "http://localhost:3000/orders/order123?eventId=ABC" \
  -H "Content-Type: application/json" \
  -d '{"userId":"customer1","drink":"Americano","modifiers":["Regular"]}'
# 返回: {"message": "订单提交成功", ...}

# 4. 咖啡师认领订单
curl -X PUT "http://localhost:3000/orders/order123?action=make&eventId=ABC&userId=barista1"
# 返回: {"message": "订单已认领", ...}

# 5. 咖啡师完成订单
curl -X PUT "http://localhost:3000/orders/order123?action=complete&eventId=ABC"
# 返回: {"message": "订单已完成", ...}
```

## 🧪 测试

### 自动化测试
运行完整的自动化测试套件：
```bash
npm test
```

测试覆盖：
- ✅ QR码生成和验证
- ✅ 订单创建和提交
- ✅ 订单查询
- ✅ 咖啡师工作流
- ✅ 订单取消
- ✅ 配置管理

### 手动测试
参考 `QUICKSTART.md` 中的手动测试示例。

## 🌟 技术特点

### 模块化设计
- 清晰的服务边界
- 单一职责原则
- 易于维护和扩展

### 事件驱动架构
- 服务间解耦
- 异步事件处理
- 灵活的扩展性

### 完整的日志
- 详细的执行日志
- 易于调试
- 便于监控

### 简单部署
- 无需云服务
- 本地即可运行
- 零配置启动

## 📚 文档导航

- **快速开始**: 阅读 `QUICKSTART.md`
- **完整文档**: 阅读 `README.md`
- **转换说明**: 阅读 `转换说明.md`
- **API文档**: 参考 `README.md` 中的API接口文档

## 🚀 下一步

1. **运行应用**: `npm start`
2. **运行测试**: `npm test`
3. **阅读文档**: 了解详细API和架构
4. **自定义配置**: 修改菜单和商店设置
5. **扩展功能**: 添加数据持久化、WebSocket等

## 💡 提示

- 应用默认运行在 `http://localhost:3000`
- 数据存储在内存中，重启后会清空
- 默认事件ID是 `ABC`
- 查看控制台日志了解执行细节

## 🔍 故障排查

遇到问题？查看 `README.md` 的"故障排查"章节。

常见问题：
- 端口占用：设置 `PORT` 环境变量
- 依赖问题：删除 `node_modules` 重新安装
- QR码过期：重新生成（5分钟有效期）

---

**转换完成时间**: 2024  
**原项目**: aws-samples/serverless-coffee  
**架构**: AWS Serverless → Node.js 单体应用  
**功能完整性**: 100%  


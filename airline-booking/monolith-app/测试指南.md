# èˆªç­é¢„è®¢ç³»ç»Ÿ - å®Œæ•´æµ‹è¯•æŒ‡å—

## ğŸ“– ç›®å½•

1. [æµ‹è¯•æ¦‚è¿°](#æµ‹è¯•æ¦‚è¿°)
2. [ä¸šåŠ¡é€»è¾‘æµ‹è¯•](#ä¸šåŠ¡é€»è¾‘æµ‹è¯•)
3. [APIç«¯ç‚¹æµ‹è¯•](#apiç«¯ç‚¹æµ‹è¯•)
4. [æ‰‹åŠ¨æµ‹è¯•æµç¨‹](#æ‰‹åŠ¨æµ‹è¯•æµç¨‹)
5. [æµ‹è¯•æ•°æ®](#æµ‹è¯•æ•°æ®)
6. [å¸¸è§é—®é¢˜](#å¸¸è§é—®é¢˜)

---

## æµ‹è¯•æ¦‚è¿°

è¿™ä¸ªèˆªç­é¢„è®¢å•ä½“åº”ç”¨åŒ…å«ä»¥ä¸‹æ ¸å¿ƒä¸šåŠ¡æ¨¡å—ï¼š

### æ ¸å¿ƒä¸šåŠ¡æ¨¡å—

| æ¨¡å— | åŠŸèƒ½ | æœåŠ¡æ–‡ä»¶ |
|------|------|----------|
| **è®¤è¯æœåŠ¡** | JWTè®¤è¯ã€ç”¨æˆ·æ³¨å†Œ/ç™»å½•ã€æƒé™æ§åˆ¶ | `services/auth.py` |
| **èˆªç­ç›®å½•** | èˆªç­æœç´¢ã€åº§ä½ç®¡ç† | `services/catalog.py` |
| **é¢„è®¢ç®¡ç†** | åˆ›å»ºã€ç¡®è®¤ã€å–æ¶ˆé¢„è®¢ | `services/booking.py` |
| **æ”¯ä»˜å¤„ç†** | æ”¶æ¬¾ã€é€€æ¬¾ | `services/payment.py` |
| **ä¼šå‘˜ç§¯åˆ†** | ç§¯åˆ†ç®¡ç†ã€ç­‰çº§æ™‹å‡ | `services/loyalty.py` |

### æµ‹è¯•å±‚çº§

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1. ä¸šåŠ¡é€»è¾‘æµ‹è¯•ï¼ˆæ— éœ€å¯åŠ¨æœåŠ¡å™¨ï¼‰        â”‚
â”‚     - æµ‹è¯•æ‰€æœ‰æœåŠ¡ç±»çš„æ–¹æ³•                â”‚
â”‚     - æµ‹è¯•æ•°æ®éªŒè¯å’Œé”™è¯¯å¤„ç†              â”‚
â”‚     - æµ‹è¯•å®Œæ•´ä¸šåŠ¡æµç¨‹                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  2. APIç«¯ç‚¹æµ‹è¯•ï¼ˆéœ€è¦å¯åŠ¨æœåŠ¡å™¨ï¼‰         â”‚
â”‚     - æµ‹è¯•HTTPç«¯ç‚¹                        â”‚
â”‚     - æµ‹è¯•è®¤è¯å’Œæˆæƒ                      â”‚
â”‚     - æµ‹è¯•è¯·æ±‚/å“åº”æ ¼å¼                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  3. å‰ç«¯é›†æˆæµ‹è¯•ï¼ˆéœ€è¦æ„å»ºå‰ç«¯ï¼‰          â”‚
â”‚     - æµ‹è¯•UIäº¤äº’                          â”‚
â”‚     - æµ‹è¯•ç«¯åˆ°ç«¯ç”¨æˆ·æµç¨‹                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ä¸šåŠ¡é€»è¾‘æµ‹è¯•

### æ–¹æ³• 1: ä½¿ç”¨å®Œæ•´æµ‹è¯•å¥—ä»¶ï¼ˆæ¨èï¼‰

è¿è¡ŒåŒ…å«æ‰€æœ‰ä¸šåŠ¡é€»è¾‘çš„ç»¼åˆæµ‹è¯•ï¼š

```bash
python test_all_business_logic.py
```

**æµ‹è¯•è¦†ç›–ï¼š**

âœ… **æ¨¡å— 1: è®¤è¯æœåŠ¡ (7 ä¸ªæµ‹è¯•)**
- ç”¨æˆ·æ³¨å†Œ
- é‡å¤æ³¨å†Œæ£€æµ‹
- ç”¨æˆ·ç™»å½•
- é”™è¯¯å¯†ç å¤„ç†
- JWTä»¤ç‰Œç”Ÿæˆå’ŒéªŒè¯
- ç®¡ç†å‘˜æƒé™æ£€æŸ¥

âœ… **æ¨¡å— 2: èˆªç­ç›®å½•æœåŠ¡ (7 ä¸ªæµ‹è¯•)**
- æœç´¢èˆªç­
- è·å–èˆªç­è¯¦æƒ…
- é¢„è®¢/é‡Šæ”¾åº§ä½
- æ»¡åº§èˆªç­å¤„ç†
- ä¸å­˜åœ¨çš„èˆªç­é”™è¯¯å¤„ç†

âœ… **æ¨¡å— 3: æ”¯ä»˜æœåŠ¡ (5 ä¸ªæµ‹è¯•)**
- æ”¶å–ä»˜æ¬¾
- å¤„ç†é€€æ¬¾
- æŸ¥è¯¢ä»˜æ¬¾è¯¦æƒ…
- æ— æ•ˆcharge IDå¤„ç†

âœ… **æ¨¡å— 4: ä¼šå‘˜ç§¯åˆ†æœåŠ¡ (6 ä¸ªæµ‹è¯•)**
- æŸ¥è¯¢å®¢æˆ·ç§¯åˆ†
- æ·»åŠ ç§¯åˆ†
- ç§¯åˆ†ç­‰çº§æ™‹å‡ï¼ˆé“œå¡â†’é“¶å¡â†’é‡‘å¡ï¼‰
- å¤„ç†é¢„è®¢ç§¯åˆ†
- æ— æ•ˆç§¯åˆ†å€¼å¤„ç†

âœ… **æ¨¡å— 5: é¢„è®¢æœåŠ¡ (8 ä¸ªæµ‹è¯•)**
- åˆ›å»ºé¢„è®¢
- ç¡®è®¤é¢„è®¢
- å–æ¶ˆé¢„è®¢
- æŸ¥è¯¢å®¢æˆ·é¢„è®¢
- æŒ‰çŠ¶æ€è¿‡æ»¤
- å‘é€é€šçŸ¥
- è¯·æ±‚éªŒè¯

âœ… **æ¨¡å— 6: å®Œæ•´é¢„è®¢æµç¨‹ (2 ä¸ªæµ‹è¯•)**
- ç«¯åˆ°ç«¯é¢„è®¢æµç¨‹ï¼ˆæœç´¢â†’é¢„è®¢â†’ä»˜æ¬¾â†’ç¡®è®¤â†’ç§¯åˆ†ï¼‰
- é¢„è®¢å–æ¶ˆæµç¨‹ï¼ˆå–æ¶ˆâ†’é€€æ¬¾â†’é‡Šæ”¾åº§ä½ï¼‰

âœ… **æ¨¡å— 7: è¾¹ç•Œæƒ…å†µå’Œé”™è¯¯å¤„ç† (6 ä¸ªæµ‹è¯•)**
- ä¸å­˜åœ¨çš„èµ„æºID
- æ— æ•ˆè¾“å…¥æ•°æ®
- è¾¹ç•Œæ¡ä»¶

**é¢„æœŸè¾“å‡ºç¤ºä¾‹ï¼š**

```
======================================================================
èˆªç­é¢„è®¢ç³»ç»Ÿ - å®Œæ•´ä¸šåŠ¡é€»è¾‘æµ‹è¯•å¥—ä»¶
======================================================================

======================================================================
æµ‹è¯•æ¨¡å— 1: è®¤è¯æœåŠ¡ (Auth Service)
======================================================================
âœ“ 1.1 ç”¨æˆ·æ³¨å†Œ - æˆåŠŸåˆ›å»ºæ–°ç”¨æˆ·
âœ“ 1.2 é‡å¤æ³¨å†Œæ£€æµ‹ - æ­£ç¡®æ‹’ç»é‡å¤é‚®ç®±
âœ“ 1.3 ç”¨æˆ·ç™»å½• - æ­£ç¡®çš„å‡­è¯
âœ“ 1.4 é”™è¯¯å¯†ç ç™»å½• - æ­£ç¡®æ‹’ç»
âœ“ 1.5 JWTä»¤ç‰Œç”Ÿæˆ - æˆåŠŸç”Ÿæˆä»¤ç‰Œ
âœ“ 1.6 JWTä»¤ç‰ŒéªŒè¯ - æˆåŠŸè§£ç ä»¤ç‰Œ
âœ“ 1.7 ç®¡ç†å‘˜ç”¨æˆ·æ£€æŸ¥ - ç®¡ç†å‘˜æƒé™æ­£ç¡®

...ï¼ˆæ›´å¤šæµ‹è¯•è¾“å‡ºï¼‰...

======================================================================
æµ‹è¯•æ€»ç»“: 41/41 é€šè¿‡
======================================================================

âœ… æ‰€æœ‰æµ‹è¯•é€šè¿‡!
```

### æ–¹æ³• 2: å•ç‹¬æµ‹è¯•å„ä¸ªæœåŠ¡

å¦‚æœä½ æƒ³å•ç‹¬æµ‹è¯•æŸä¸ªæœåŠ¡ï¼Œå¯ä»¥åˆ›å»ºä¸“é—¨çš„æµ‹è¯•è„šæœ¬ï¼š

#### æµ‹è¯•èˆªç­ç›®å½•æœåŠ¡

```python
from services.catalog import CatalogService

# æœç´¢èˆªç­
flights = CatalogService.search_flights("LAX", "SFO", "2025-11-10")
print(f"æ‰¾åˆ° {len(flights)} ä¸ªèˆªç­")

# è·å–èˆªç­è¯¦æƒ…
flight = CatalogService.get_flight("FL001")
print(f"èˆªç­: {flight['departureAirportCode']} â†’ {flight['arrivalAirportCode']}")
print(f"å¯ç”¨åº§ä½: {flight['seatCapacity']}")

# é¢„è®¢åº§ä½
CatalogService.reserve_flight_seat("FL001")
flight_after = CatalogService.get_flight("FL001")
print(f"é¢„è®¢ååº§ä½: {flight_after['seatCapacity']}")
```

#### æµ‹è¯•é¢„è®¢æœåŠ¡

```python
from services.booking import BookingService

# åˆ›å»ºé¢„è®¢
booking_data = {
    'outboundFlightId': 'FL001',
    'customerId': 'test-customer',
    'chargeId': 'ch_test_123'
}
booking_id = BookingService.reserve_booking(booking_data)
print(f"é¢„è®¢ID: {booking_id}")

# ç¡®è®¤é¢„è®¢
reference = BookingService.confirm_booking(booking_id)
print(f"é¢„è®¢ç¡®è®¤ç : {reference}")

# æŸ¥è¯¢é¢„è®¢
booking = BookingService.get_booking(booking_id)
print(f"é¢„è®¢çŠ¶æ€: {booking['status']}")
```

#### æµ‹è¯•æ”¯ä»˜æœåŠ¡

```python
from services.payment import PaymentService

# æ”¶å–ä»˜æ¬¾
payment = PaymentService.collect_payment("ch_test_123")
print(f"ä»˜æ¬¾é‡‘é¢: ${payment['price']}")
print(f"æ”¶æ®URL: {payment['receiptUrl']}")

# é€€æ¬¾
refund = PaymentService.refund_payment("ch_test_123")
print(f"é€€æ¬¾ID: {refund['refundId']}")
```

#### æµ‹è¯•ä¼šå‘˜ç§¯åˆ†æœåŠ¡

```python
from services.loyalty import LoyaltyService

# æŸ¥è¯¢ç§¯åˆ†
loyalty = LoyaltyService.get_customer_loyalty("customer123")
print(f"ç§¯åˆ†: {loyalty['points']}")
print(f"ç­‰çº§: {loyalty['level']}")
print(f"è·ç¦»ä¸‹ä¸€ç­‰çº§: {loyalty['remainingPoints']} ç§¯åˆ†")

# æ·»åŠ ç§¯åˆ†
LoyaltyService.add_loyalty_points("customer123", 1000)

# å¤„ç†é¢„è®¢ç§¯åˆ†
LoyaltyService.process_booking_loyalty("customer123", 150.0)
```

---

## APIç«¯ç‚¹æµ‹è¯•

APIæµ‹è¯•éœ€è¦å…ˆå¯åŠ¨æœåŠ¡å™¨ã€‚

### æ­¥éª¤ 1: å¯åŠ¨æœåŠ¡å™¨

```bash
# åœ¨ç¬¬ä¸€ä¸ªç»ˆç«¯å¯åŠ¨æœåŠ¡å™¨
python run.py
```

ç­‰å¾…æœåŠ¡å™¨å¯åŠ¨ï¼Œåº”è¯¥çœ‹åˆ°ï¼š
```
Starting Airline Booking Application...
Server running on http://localhost:5000
```

### æ­¥éª¤ 2: è¿è¡ŒAPIæµ‹è¯•

æ‰“å¼€æ–°ç»ˆç«¯å¹¶è¿è¡Œï¼š

```bash
python test_api_endpoints.py
```

### æ­¥éª¤ 3: ä½¿ç”¨ curl æ‰‹åŠ¨æµ‹è¯•

#### 3.1 è®¤è¯æµç¨‹

**æ³¨å†Œæ–°ç”¨æˆ·ï¼š**
```bash
curl -X POST http://localhost:5000/auth/register \
  -H "Content-Type: application/json" \
  -d '{
    "email": "newuser@example.com",
    "password": "mypassword123"
  }'
```

**ç™»å½•è·å–ä»¤ç‰Œï¼š**
```bash
curl -X POST http://localhost:5000/auth/login \
  -H "Content-Type: application/json" \
  -d '{
    "email": "user@example.com",
    "password": "password123"
  }'
```

ä¿å­˜è¿”å›çš„ `access_token`ï¼Œåç»­è¯·æ±‚éœ€è¦ä½¿ç”¨ï¼š
```json
{
  "access_token": "eyJ0eXAiOiJKV1QiLCJhbGc...",
  "token_type": "Bearer",
  "expires_in": 1800,
  "user": {
    "sub": "user_id_123",
    "email": "user@example.com",
    "groups": ["user"]
  }
}
```

**éªŒè¯å½“å‰ç”¨æˆ·ï¼š**
```bash
TOKEN="your_access_token_here"

curl http://localhost:5000/auth/me \
  -H "Authorization: Bearer $TOKEN"
```

#### 3.2 èˆªç­æœç´¢å’ŒæŸ¥è¯¢

**æœç´¢èˆªç­ï¼š**
```bash
curl "http://localhost:5000/flights/search?departureCode=LAX&arrivalCode=SFO&departureDate=2025-11-10"
```

**è·å–èˆªç­è¯¦æƒ…ï¼š**
```bash
curl http://localhost:5000/flights/FL001
```

**é¢„è®¢åº§ä½ï¼š**
```bash
curl -X POST http://localhost:5000/flights/FL001/reserve
```

**é‡Šæ”¾åº§ä½ï¼š**
```bash
curl -X POST http://localhost:5000/flights/FL001/release
```

#### 3.3 åˆ›å»ºé¢„è®¢ï¼ˆå®Œæ•´æµç¨‹ï¼‰

```bash
TOKEN="your_access_token_here"

curl -X POST http://localhost:5000/bookings \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "outboundFlightId": "FL001",
    "chargeId": "ch_test_12345"
  }'
```

è¿™ä¸ªè¯·æ±‚ä¼šè‡ªåŠ¨å®Œæˆä»¥ä¸‹æ­¥éª¤ï¼š
1. âœ… é¢„è®¢åº§ä½
2. âœ… åˆ›å»ºé¢„è®¢è®°å½•
3. âœ… å¤„ç†ä»˜æ¬¾
4. âœ… ç¡®è®¤é¢„è®¢
5. âœ… æ·»åŠ ä¼šå‘˜ç§¯åˆ†
6. âœ… å‘é€é€šçŸ¥

**æˆåŠŸå“åº”ç¤ºä¾‹ï¼š**
```json
{
  "bookingId": "booking_abc123",
  "bookingReference": "REF789XYZ",
  "status": "CONFIRMED",
  "payment": {
    "receiptUrl": "https://payment.example.com/receipts/ch_test_12345",
    "price": 150
  },
  "notification": {
    "notificationId": "notif_xyz456",
    "customerId": "user_id_123",
    "price": 150,
    "status": "confirmed"
  }
}
```

#### 3.4 æŸ¥è¯¢é¢„è®¢

**æŸ¥è¯¢å•ä¸ªé¢„è®¢ï¼š**
```bash
TOKEN="your_access_token_here"
BOOKING_ID="booking_abc123"

curl http://localhost:5000/bookings/$BOOKING_ID \
  -H "Authorization: Bearer $TOKEN"
```

**æŸ¥è¯¢ç”¨æˆ·çš„æ‰€æœ‰é¢„è®¢ï¼š**
```bash
TOKEN="your_access_token_here"

# å…ˆè·å–ç”¨æˆ·ID
USER_ID=$(curl -s http://localhost:5000/auth/me \
  -H "Authorization: Bearer $TOKEN" | grep -o '"sub":"[^"]*"' | cut -d'"' -f4)

# æŸ¥è¯¢è¯¥ç”¨æˆ·çš„æ‰€æœ‰é¢„è®¢
curl "http://localhost:5000/customers/$USER_ID/bookings" \
  -H "Authorization: Bearer $TOKEN"
```

**æŒ‰çŠ¶æ€è¿‡æ»¤ï¼š**
```bash
# åªæŸ¥è¯¢å·²ç¡®è®¤çš„é¢„è®¢
curl "http://localhost:5000/customers/$USER_ID/bookings?status=CONFIRMED" \
  -H "Authorization: Bearer $TOKEN"
```

#### 3.5 å–æ¶ˆé¢„è®¢

```bash
TOKEN="your_access_token_here"
BOOKING_ID="booking_abc123"

curl -X POST http://localhost:5000/bookings/$BOOKING_ID/cancel \
  -H "Authorization: Bearer $TOKEN"
```

è¿™ä¼šè‡ªåŠ¨å®Œæˆï¼š
1. âœ… å–æ¶ˆé¢„è®¢
2. âœ… é‡Šæ”¾åº§ä½
3. âœ… é€€æ¬¾
4. âœ… å‘é€å–æ¶ˆé€šçŸ¥

#### 3.6 ä¼šå‘˜ç§¯åˆ†æŸ¥è¯¢

```bash
TOKEN="your_access_token_here"
USER_ID="your_user_id"

curl http://localhost:5000/loyalty/$USER_ID \
  -H "Authorization: Bearer $TOKEN"
```

**å“åº”ç¤ºä¾‹ï¼š**
```json
{
  "points": 150,
  "level": "bronze",
  "remainingPoints": 49850
}
```

#### 3.7 ç®¡ç†å‘˜åŠŸèƒ½

**ä»¥ç®¡ç†å‘˜èº«ä»½ç™»å½•ï¼š**
```bash
ADMIN_TOKEN=$(curl -s -X POST http://localhost:5000/auth/login \
  -H "Content-Type: application/json" \
  -d '{
    "email": "admin@example.com",
    "password": "admin123"
  }' | grep -o '"access_token":"[^"]*"' | cut -d'"' -f4)
```

**åˆ—å‡ºæ‰€æœ‰ç”¨æˆ·ï¼ˆä»…ç®¡ç†å‘˜ï¼‰ï¼š**
```bash
curl http://localhost:5000/auth/users \
  -H "Authorization: Bearer $ADMIN_TOKEN"
```

**æ‰‹åŠ¨æ·»åŠ ç§¯åˆ†ï¼ˆä»…ç®¡ç†å‘˜ï¼‰ï¼š**
```bash
curl -X POST http://localhost:5000/loyalty/user123/points \
  -H "Authorization: Bearer $ADMIN_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"points": 5000}'
```

---

## æ‰‹åŠ¨æµ‹è¯•æµç¨‹

### åœºæ™¯ 1: æ–°ç”¨æˆ·å®Œæ•´é¢„è®¢æµç¨‹

**ç›®æ ‡**: æµ‹è¯•ä»æ³¨å†Œåˆ°å®Œæˆé¢„è®¢çš„å®Œæ•´æµç¨‹

**æ­¥éª¤:**

1. **æ³¨å†Œæ–°ç”¨æˆ·**
   ```bash
   curl -X POST http://localhost:5000/auth/register \
     -H "Content-Type: application/json" \
     -d '{
       "email": "testuser@example.com",
       "password": "test123"
     }'
   ```

2. **ç™»å½•è·å–ä»¤ç‰Œ**
   ```bash
   TOKEN=$(curl -s -X POST http://localhost:5000/auth/login \
     -H "Content-Type: application/json" \
     -d '{
       "email": "testuser@example.com",
       "password": "test123"
     }' | grep -o '"access_token":"[^"]*"' | cut -d'"' -f4)
   
   echo "Token: $TOKEN"
   ```

3. **æœç´¢èˆªç­**
   ```bash
   curl "http://localhost:5000/flights/search?departureCode=LAX&arrivalCode=SFO&departureDate=2025-11-10"
   ```

4. **æŸ¥çœ‹èˆªç­è¯¦æƒ…**
   ```bash
   curl http://localhost:5000/flights/FL001
   ```

5. **åˆ›å»ºé¢„è®¢**
   ```bash
   curl -X POST http://localhost:5000/bookings \
     -H "Authorization: Bearer $TOKEN" \
     -H "Content-Type: application/json" \
     -d '{
       "outboundFlightId": "FL001",
       "chargeId": "ch_test_scenario1"
     }' | python -m json.tool
   ```

6. **ä¿å­˜é¢„è®¢IDå¹¶æŸ¥è¯¢**
   ```bash
   BOOKING_ID="ä»ä¸Šä¸€æ­¥è·å–çš„bookingId"
   
   curl http://localhost:5000/bookings/$BOOKING_ID \
     -H "Authorization: Bearer $TOKEN"
   ```

7. **æŸ¥è¯¢ç§¯åˆ†**
   ```bash
   USER_ID=$(curl -s http://localhost:5000/auth/me \
     -H "Authorization: Bearer $TOKEN" | grep -o '"sub":"[^"]*"' | cut -d'"' -f4)
   
   curl http://localhost:5000/loyalty/$USER_ID \
     -H "Authorization: Bearer $TOKEN"
   ```

**é¢„æœŸç»“æœ:**
- âœ… ç”¨æˆ·æˆåŠŸæ³¨å†Œå¹¶è·å¾—ä»¤ç‰Œ
- âœ… æ‰¾åˆ°å¯ç”¨èˆªç­
- âœ… é¢„è®¢æˆåŠŸï¼ŒçŠ¶æ€ä¸º CONFIRMED
- âœ… èˆªç­åº§ä½æ•°é‡å‡å°‘1
- âœ… ç§¯åˆ†å¢åŠ ï¼ˆç­‰äºç¥¨ä»·ï¼‰
- âœ… ç­‰çº§ä¸º bronze

---

### åœºæ™¯ 2: é¢„è®¢å–æ¶ˆå’Œé€€æ¬¾

**ç›®æ ‡**: æµ‹è¯•å–æ¶ˆé¢„è®¢çš„å®Œæ•´æµç¨‹

**æ­¥éª¤:**

1. **ä½¿ç”¨å·²æœ‰ä»¤ç‰Œåˆ›å»ºé¢„è®¢**
   ```bash
   BOOKING_RESPONSE=$(curl -s -X POST http://localhost:5000/bookings \
     -H "Authorization: Bearer $TOKEN" \
     -H "Content-Type: application/json" \
     -d '{
       "outboundFlightId": "FL002",
       "chargeId": "ch_test_cancel_123"
     }')
   
   BOOKING_ID=$(echo $BOOKING_RESPONSE | grep -o '"bookingId":"[^"]*"' | cut -d'"' -f4)
   echo "é¢„è®¢ID: $BOOKING_ID"
   ```

2. **è®°å½•å–æ¶ˆå‰çš„èˆªç­åº§ä½æ•°**
   ```bash
   curl http://localhost:5000/flights/FL002 | grep seatCapacity
   ```

3. **å–æ¶ˆé¢„è®¢**
   ```bash
   curl -X POST http://localhost:5000/bookings/$BOOKING_ID/cancel \
     -H "Authorization: Bearer $TOKEN" | python -m json.tool
   ```

4. **éªŒè¯é¢„è®¢çŠ¶æ€**
   ```bash
   curl http://localhost:5000/bookings/$BOOKING_ID \
     -H "Authorization: Bearer $TOKEN"
   ```

5. **éªŒè¯åº§ä½å·²é‡Šæ”¾**
   ```bash
   curl http://localhost:5000/flights/FL002 | grep seatCapacity
   ```

**é¢„æœŸç»“æœ:**
- âœ… é¢„è®¢çŠ¶æ€å˜ä¸º CANCELLED
- âœ… åº§ä½æ•°é‡æ¢å¤
- âœ… æ”¶åˆ°é€€æ¬¾ID
- âœ… å‘é€å–æ¶ˆé€šçŸ¥

---

### åœºæ™¯ 3: æƒé™æµ‹è¯•

**ç›®æ ‡**: æµ‹è¯•æ‰€æœ‰è€…å’Œç®¡ç†å‘˜æƒé™

**æ­¥éª¤:**

1. **ç”¨æˆ·Aåˆ›å»ºé¢„è®¢**
   ```bash
   TOKEN_A=$(curl -s -X POST http://localhost:5000/auth/login \
     -H "Content-Type: application/json" \
     -d '{"email": "user@example.com", "password": "password123"}' \
     | grep -o '"access_token":"[^"]*"' | cut -d'"' -f4)
   
   BOOKING_A=$(curl -s -X POST http://localhost:5000/bookings \
     -H "Authorization: Bearer $TOKEN_A" \
     -H "Content-Type: application/json" \
     -d '{"outboundFlightId": "FL001", "chargeId": "ch_perm_test_a"}' \
     | grep -o '"bookingId":"[^"]*"' | cut -d'"' -f4)
   ```

2. **ç”¨æˆ·Bå°è¯•æŸ¥çœ‹ç”¨æˆ·Açš„é¢„è®¢ï¼ˆåº”è¯¥å¤±è´¥ï¼‰**
   ```bash
   # æ³¨å†Œå¹¶ç™»å½•ç”¨æˆ·B
   curl -X POST http://localhost:5000/auth/register \
     -H "Content-Type: application/json" \
     -d '{"email": "userb@example.com", "password": "password123"}'
   
   TOKEN_B=$(curl -s -X POST http://localhost:5000/auth/login \
     -H "Content-Type: application/json" \
     -d '{"email": "userb@example.com", "password": "password123"}' \
     | grep -o '"access_token":"[^"]*"' | cut -d'"' -f4)
   
   # å°è¯•æŸ¥çœ‹ç”¨æˆ·Açš„é¢„è®¢ï¼ˆåº”è¿”å›403æˆ–ç±»ä¼¼é”™è¯¯ï¼‰
   curl http://localhost:5000/bookings/$BOOKING_A \
     -H "Authorization: Bearer $TOKEN_B"
   ```

3. **ç®¡ç†å‘˜æŸ¥çœ‹ç”¨æˆ·Açš„é¢„è®¢ï¼ˆåº”è¯¥æˆåŠŸï¼‰**
   ```bash
   ADMIN_TOKEN=$(curl -s -X POST http://localhost:5000/auth/login \
     -H "Content-Type: application/json" \
     -d '{"email": "admin@example.com", "password": "admin123"}' \
     | grep -o '"access_token":"[^"]*"' | cut -d'"' -f4)
   
   curl http://localhost:5000/bookings/$BOOKING_A \
     -H "Authorization: Bearer $ADMIN_TOKEN"
   ```

4. **æ™®é€šç”¨æˆ·å°è¯•æ·»åŠ ç§¯åˆ†ï¼ˆåº”è¯¥å¤±è´¥ï¼‰**
   ```bash
   curl -X POST http://localhost:5000/loyalty/someuser/points \
     -H "Authorization: Bearer $TOKEN_A" \
     -H "Content-Type: application/json" \
     -d '{"points": 1000}'
   ```

5. **ç®¡ç†å‘˜æ·»åŠ ç§¯åˆ†ï¼ˆåº”è¯¥æˆåŠŸï¼‰**
   ```bash
   curl -X POST http://localhost:5000/loyalty/someuser/points \
     -H "Authorization: Bearer $ADMIN_TOKEN" \
     -H "Content-Type: application/json" \
     -d '{"points": 1000}'
   ```

**é¢„æœŸç»“æœ:**
- âœ… ç”¨æˆ·åªèƒ½æŸ¥çœ‹è‡ªå·±çš„é¢„è®¢
- âœ… ç®¡ç†å‘˜å¯ä»¥æŸ¥çœ‹æ‰€æœ‰é¢„è®¢
- âœ… åªæœ‰ç®¡ç†å‘˜å¯ä»¥æ‰‹åŠ¨æ·»åŠ ç§¯åˆ†

---

### åœºæ™¯ 4: é”™è¯¯å¤„ç†æµ‹è¯•

**ç›®æ ‡**: æµ‹è¯•å„ç§é”™è¯¯æƒ…å†µçš„å¤„ç†

**æ­¥éª¤:**

1. **é¢„è®¢ä¸å­˜åœ¨çš„èˆªç­**
   ```bash
   curl -X POST http://localhost:5000/bookings \
     -H "Authorization: Bearer $TOKEN" \
     -H "Content-Type: application/json" \
     -d '{
       "outboundFlightId": "FL999",
       "chargeId": "ch_test"
     }'
   ```
   **é¢„æœŸ**: è¿”å›é”™è¯¯ "Flight FL999 does not exist"

2. **æ— æ•ˆçš„ä»¤ç‰Œ**
   ```bash
   curl http://localhost:5000/bookings/some_id \
     -H "Authorization: Bearer invalid_token"
   ```
   **é¢„æœŸ**: è¿”å› 401 Unauthorized

3. **ç¼ºå°‘å¿…éœ€å­—æ®µ**
   ```bash
   curl -X POST http://localhost:5000/bookings \
     -H "Authorization: Bearer $TOKEN" \
     -H "Content-Type: application/json" \
     -d '{
       "outboundFlightId": "FL001"
     }'
   ```
   **é¢„æœŸ**: è¿”å›é”™è¯¯ "chargeId is required"

4. **æŸ¥è¯¢ä¸å­˜åœ¨çš„é¢„è®¢**
   ```bash
   curl http://localhost:5000/bookings/nonexistent_booking \
     -H "Authorization: Bearer $TOKEN"
   ```
   **é¢„æœŸ**: è¿”å›é”™è¯¯ "Booking not found"

5. **æ·»åŠ è´Ÿæ•°ç§¯åˆ†**
   ```bash
   curl -X POST http://localhost:5000/loyalty/user123/points \
     -H "Authorization: Bearer $ADMIN_TOKEN" \
     -H "Content-Type: application/json" \
     -d '{"points": -100}'
   ```
   **é¢„æœŸ**: è¿”å›é”™è¯¯ "Points must be a positive number"

---

## æµ‹è¯•æ•°æ®

### é¢„è£…èˆªç­æ•°æ®

ç³»ç»Ÿé¢„è£…äº†ä»¥ä¸‹æµ‹è¯•èˆªç­ï¼š

| èˆªç­ID | è·¯çº¿ | æ—¥æœŸ | ä»·æ ¼ | åº§ä½æ•° |
|--------|------|------|------|--------|
| FL001 | LAX â†’ SFO | 2025-11-10 | $150 | 100 |
| FL002 | JFK â†’ LAX | 2025-11-12 | $300 | 150 |

### é¢„è£…ç”¨æˆ·æ•°æ®

| è§’è‰² | é‚®ç®± | å¯†ç  | æƒé™ |
|------|------|------|------|
| æ™®é€šç”¨æˆ· | user@example.com | password123 | user |
| ç®¡ç†å‘˜ | admin@example.com | admin123 | admin, user |

### ä¼šå‘˜ç­‰çº§

| ç­‰çº§ | ç§¯åˆ†èŒƒå›´ |
|------|----------|
| é“œå¡ (Bronze) | 1 - 49,999 |
| é“¶å¡ (Silver) | 50,000 - 99,999 |
| é‡‘å¡ (Gold) | 100,000+ |

ç§¯åˆ†è§„åˆ™: æ¶ˆè´¹é‡‘é¢ 1:1 è½¬æ¢ä¸ºç§¯åˆ†ï¼ˆ$150 = 150ç§¯åˆ†ï¼‰

---

## å¸¸è§é—®é¢˜

### Q1: å¦‚ä½•é‡ç½®æµ‹è¯•æ•°æ®ï¼Ÿ

**A**: é‡å¯åº”ç”¨å³å¯ï¼Œæ‰€æœ‰æ•°æ®éƒ½å­˜å‚¨åœ¨å†…å­˜ä¸­ï¼š
```bash
# åœæ­¢æœåŠ¡å™¨ (Ctrl+C)
# é‡æ–°å¯åŠ¨
python run.py
```

### Q2: å¦‚ä½•æµ‹è¯•æ»¡åº§èˆªç­çš„æƒ…å†µï¼Ÿ

**A**: ä½¿ç”¨è„šæœ¬é¢„è®¢æ‰€æœ‰åº§ä½ï¼š
```bash
# è·å–èˆªç­FL001çš„åº§ä½æ•°
SEATS=$(curl -s http://localhost:5000/flights/FL001 | grep -o '"seatCapacity":[0-9]*' | cut -d':' -f2)

# é¢„è®¢æ‰€æœ‰åº§ä½
for i in $(seq 1 $SEATS); do
  curl -X POST http://localhost:5000/flights/FL001/reserve
done

# å†æ¬¡å°è¯•é¢„è®¢ï¼ˆåº”è¯¥å¤±è´¥ï¼‰
curl -X POST http://localhost:5000/flights/FL001/reserve
```

### Q3: å¦‚ä½•æµ‹è¯•æ”¯ä»˜å¤±è´¥çš„æƒ…å†µï¼Ÿ

**A**: å½“å‰ç‰ˆæœ¬ä½¿ç”¨æ¨¡æ‹Ÿæ”¯ä»˜ï¼Œå§‹ç»ˆæˆåŠŸã€‚è¦æµ‹è¯•å¤±è´¥æƒ…å†µï¼Œå¯ä»¥ä¿®æ”¹ä»£ç æˆ–ä½¿ç”¨çœŸå®çš„Stripeé›†æˆå¹¶æä¾›æ— æ•ˆçš„charge IDã€‚

### Q4: ä»¤ç‰Œè¿‡æœŸäº†æ€ä¹ˆåŠï¼Ÿ

**A**: JWTä»¤ç‰Œé»˜è®¤30åˆ†é’Ÿæœ‰æ•ˆæœŸã€‚è¿‡æœŸåé‡æ–°ç™»å½•è·å–æ–°ä»¤ç‰Œï¼š
```bash
TOKEN=$(curl -s -X POST http://localhost:5000/auth/login \
  -H "Content-Type: application/json" \
  -d '{"email": "user@example.com", "password": "password123"}' \
  | grep -o '"access_token":"[^"]*"' | cut -d'"' -f4)
```

### Q5: å¦‚ä½•éªŒè¯äº‹åŠ¡å›æ»šï¼Ÿ

**A**: åˆ›å»ºä¸€ä¸ªä¼šå¤±è´¥çš„é¢„è®¢ï¼Œæ£€æŸ¥åº§ä½æ˜¯å¦è¢«æ­£ç¡®é‡Šæ”¾ï¼š

```python
# ä¿®æ”¹ services/payment.py è®©ä»˜æ¬¾å¤±è´¥
# ä¸´æ—¶æ·»åŠ ï¼š
# if charge_id == "ch_fail_test":
#     raise ValueError("Payment processing failed")

# ç„¶åå°è¯•é¢„è®¢
curl -X POST http://localhost:5000/bookings \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "outboundFlightId": "FL001",
    "chargeId": "ch_fail_test"
  }'

# æ£€æŸ¥åº§ä½æ˜¯å¦è¢«é‡Šæ”¾ï¼ˆåº”è¯¥å’Œä¹‹å‰ä¸€æ ·ï¼‰
curl http://localhost:5000/flights/FL001
```

### Q6: å¦‚ä½•æµ‹è¯•å¹¶å‘é¢„è®¢ï¼Ÿ

**A**: ä½¿ç”¨å¤šçº¿ç¨‹æˆ–å¤šè¿›ç¨‹åŒæ—¶å‘é€è¯·æ±‚ï¼š

```bash
# ä½¿ç”¨ GNU parallel æˆ– xargs å¹¶å‘è¯·æ±‚
seq 10 | xargs -P 10 -I {} curl -X POST http://localhost:5000/flights/FL001/reserve
```

### Q7: å¦‚ä½•é›†æˆçœŸå®çš„Stripeæ”¯ä»˜ï¼Ÿ

**A**: è®¾ç½® STRIPE_SECRET_KEY ç¯å¢ƒå˜é‡ï¼š

```bash
export STRIPE_SECRET_KEY="sk_test_your_key_here"
python run.py
```

ç„¶åä½¿ç”¨çœŸå®çš„Stripe charge IDæˆ–payment intent IDè¿›è¡Œæµ‹è¯•ã€‚

---

## æµ‹è¯•æ£€æŸ¥æ¸…å•

ä½¿ç”¨æ­¤æ¸…å•ç¡®ä¿æ‰€æœ‰ä¸šåŠ¡é€»è¾‘éƒ½å·²æµ‹è¯•ï¼š

### è®¤è¯æœåŠ¡
- [ ] ç”¨æˆ·æ³¨å†ŒæˆåŠŸ
- [ ] é‡å¤é‚®ç®±æ³¨å†Œè¢«æ‹’ç»
- [ ] æ­£ç¡®å¯†ç ç™»å½•æˆåŠŸ
- [ ] é”™è¯¯å¯†ç ç™»å½•å¤±è´¥
- [ ] JWTä»¤ç‰Œç”Ÿæˆå’ŒéªŒè¯
- [ ] ä»¤ç‰Œè¿‡æœŸå¤„ç†
- [ ] ç®¡ç†å‘˜æƒé™æ£€æŸ¥

### èˆªç­ç›®å½•
- [ ] æœç´¢èˆªç­è¿”å›æ­£ç¡®ç»“æœ
- [ ] æœç´¢ä¸å­˜åœ¨çš„èˆªç­è¿”å›ç©ºåˆ—è¡¨
- [ ] è·å–èˆªç­è¯¦æƒ…æˆåŠŸ
- [ ] è·å–ä¸å­˜åœ¨çš„èˆªç­æŠ›å‡ºé”™è¯¯
- [ ] é¢„è®¢åº§ä½å‡å°‘åº§ä½æ•°
- [ ] é‡Šæ”¾åº§ä½å¢åŠ åº§ä½æ•°
- [ ] æ»¡åº§èˆªç­æ‹’ç»é¢„è®¢

### é¢„è®¢ç®¡ç†
- [ ] åˆ›å»ºé¢„è®¢æˆåŠŸ
- [ ] ç¡®è®¤é¢„è®¢æˆåŠŸ
- [ ] å–æ¶ˆé¢„è®¢æˆåŠŸ
- [ ] æŸ¥è¯¢å®¢æˆ·æ‰€æœ‰é¢„è®¢
- [ ] æŒ‰çŠ¶æ€è¿‡æ»¤é¢„è®¢
- [ ] é¢„è®¢é€šçŸ¥å‘é€
- [ ] ç¼ºå°‘å­—æ®µçš„è¯·æ±‚è¢«æ‹’ç»

### æ”¯ä»˜å¤„ç†
- [ ] æ”¶å–ä»˜æ¬¾æˆåŠŸ
- [ ] å¤„ç†é€€æ¬¾æˆåŠŸ
- [ ] æŸ¥è¯¢ä»˜æ¬¾è¯¦æƒ…
- [ ] æ— æ•ˆcharge IDè¢«æ‹’ç»
- [ ] æŸ¥è¯¢ä¸å­˜åœ¨çš„ä»˜æ¬¾æŠ›å‡ºé”™è¯¯

### ä¼šå‘˜ç§¯åˆ†
- [ ] æ–°å®¢æˆ·ç§¯åˆ†ä¸º0
- [ ] æ·»åŠ ç§¯åˆ†æˆåŠŸ
- [ ] ç§¯åˆ†è¾¾åˆ°50000æ™‹å‡é“¶å¡
- [ ] ç§¯åˆ†è¾¾åˆ°100000æ™‹å‡é‡‘å¡
- [ ] å¤„ç†é¢„è®¢ç§¯åˆ†ï¼ˆ1:1æ¯”ä¾‹ï¼‰
- [ ] è´Ÿæ•°ç§¯åˆ†è¢«æ‹’ç»

### å®Œæ•´æµç¨‹
- [ ] ç«¯åˆ°ç«¯é¢„è®¢æµç¨‹å®Œæ•´
- [ ] é¢„è®¢å–æ¶ˆæµç¨‹å®Œæ•´
- [ ] äº‹åŠ¡å›æ»šæœºåˆ¶æ­£å¸¸
- [ ] å¹¶å‘é¢„è®¢å¤„ç†æ­£ç¡®

### æƒé™æ§åˆ¶
- [ ] ç”¨æˆ·åªèƒ½æŸ¥çœ‹è‡ªå·±çš„é¢„è®¢
- [ ] ç®¡ç†å‘˜å¯ä»¥æŸ¥çœ‹æ‰€æœ‰é¢„è®¢
- [ ] ç®¡ç†å‘˜å¯ä»¥æ‰‹åŠ¨æ·»åŠ ç§¯åˆ†
- [ ] æ™®é€šç”¨æˆ·æ— æ³•æ‰‹åŠ¨æ·»åŠ ç§¯åˆ†
- [ ] æ— ä»¤ç‰Œè®¿é—®è¢«æ‹’ç»
- [ ] æ— æ•ˆä»¤ç‰Œè¢«æ‹’ç»

---

## æ€»ç»“

è¿™ä»½æµ‹è¯•æŒ‡å—æ¶µç›–äº†èˆªç­é¢„è®¢ç³»ç»Ÿçš„æ‰€æœ‰æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ï¼š

âœ… **7ä¸ªä¸šåŠ¡æ¨¡å—** - è®¤è¯ã€èˆªç­ã€é¢„è®¢ã€æ”¯ä»˜ã€ç§¯åˆ†ã€æµç¨‹ã€é”™è¯¯å¤„ç†  
âœ… **41+ä¸ªæµ‹è¯•ç”¨ä¾‹** - è¦†ç›–æ­£å¸¸æµç¨‹å’Œå¼‚å¸¸æƒ…å†µ  
âœ… **3ç§æµ‹è¯•æ–¹æ³•** - ä¸šåŠ¡é€»è¾‘æµ‹è¯•ã€APIæµ‹è¯•ã€æ‰‹åŠ¨æµ‹è¯•  
âœ… **4ä¸ªå®Œæ•´åœºæ™¯** - æ–°ç”¨æˆ·é¢„è®¢ã€å–æ¶ˆé€€æ¬¾ã€æƒé™éªŒè¯ã€é”™è¯¯å¤„ç†  

è¿è¡Œ `python test_all_business_logic.py` å¼€å§‹æµ‹è¯•ï¼


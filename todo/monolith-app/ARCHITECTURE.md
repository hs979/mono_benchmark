# Todo单体应用架构文档

## 架构概览

这是一个基于Node.js的传统三层架构Web应用。

```
┌─────────────────────────────────────────────────────────────┐
│                         用户浏览器                            │
│                     (http://localhost:3000)                 │
└────────────────────────┬────────────────────────────────────┘
                         │
                         │ HTTP请求
                         ▼
┌─────────────────────────────────────────────────────────────┐
│                    React前端应用                              │
│  ┌──────────────────────────────────────────────────────┐  │
│  │  App.js (主组件)                                      │  │
│  │  ├─ 用户认证管理（登录/注册/登出）                      │  │
│  │  ├─ JWT令牌存储（localStorage）                       │  │
│  │  └─ ToDo.js (待办事项UI组件)                          │  │
│  └──────────────────────────────────────────────────────┘  │
└────────────────────────┬────────────────────────────────────┘
                         │
                         │ HTTP/REST API
                         │ (axios + JWT Token)
                         ▼
┌─────────────────────────────────────────────────────────────┐
│               Express后端服务 (Port 8080)                    │
│  ┌──────────────────────────────────────────────────────┐  │
│  │  server.js (主服务器)                                 │  │
│  │                                                         │  │
│  │  ┌────────────────┐      ┌──────────────────┐        │  │
│  │  │  认证路由       │      │  Todo业务路由     │        │  │
│  │  │  /auth/*       │      │  /api/item/*     │        │  │
│  │  │                │      │                  │        │  │
│  │  │ • POST /register│     │ • GET /item      │        │  │
│  │  │ • POST /login  │      │ • POST /item     │        │  │
│  │  └────────────────┘      │ • PUT /item/:id  │        │  │
│  │                          │ • DELETE /item/:id│       │  │
│  │  ┌────────────────┐      └──────────────────┘        │  │
│  │  │  JWT中间件      │                                   │  │
│  │  │  (验证令牌)     │                                   │  │
│  │  └────────────────┘                                   │  │
│  └──────────────────────────────────────────────────────┘  │
└────────────────────────┬────────────────────────────────────┘
                         │
                         │ AWS SDK
                         │ (DynamoDB API调用)
                         ▼
┌─────────────────────────────────────────────────────────────┐
│                    AWS DynamoDB                              │
│  ┌────────────────────────┐  ┌──────────────────────────┐  │
│  │  todo-monolith-users   │  │  todo-monolith-table     │  │
│  │  (用户表)              │  │  (待办事项表)            │  │
│  │                        │  │                          │  │
│  │  主键: username        │  │  分区键: cognito-username│  │
│  │  属性:                 │  │  排序键: id              │  │
│  │  • password (加密)     │  │  属性:                   │  │
│  │  • email               │  │  • item (内容)           │  │
│  │  • createdAt           │  │  • completed (状态)      │  │
│  └────────────────────────┘  │  • creation_date         │  │
│                               │  • lastupdate_date       │  │
│                               └──────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
```

## 数据流分析

### 1. 用户注册流程

```
用户输入 → 前端验证 → POST /auth/register
    ↓
后端接收 → 验证用户名是否存在
    ↓
密码加密(bcrypt) → 存入用户表
    ↓
生成JWT令牌 → 返回给前端
    ↓
前端存储令牌 → 自动登录状态
```

### 2. 用户登录流程

```
用户输入 → 前端验证 → POST /auth/login
    ↓
后端接收 → 从用户表查询
    ↓
密码验证(bcrypt.compare) → 验证成功
    ↓
生成JWT令牌 → 返回给前端
    ↓
前端存储令牌(localStorage) → 进入应用主界面
```

### 3. 待办事项操作流程

```
用户操作 → 前端发送请求(携带JWT)
    ↓
后端中间件验证JWT → 提取用户信息
    ↓
根据用户名查询/操作数据 → 确保数据隔离
    ↓
返回结果 → 前端更新UI
```

## 技术选型说明

### 后端技术栈

| 技术 | 用途 | 选择理由 |
|------|------|----------|
| Express.js | Web框架 | 轻量、灵活、生态丰富 |
| jsonwebtoken | JWT生成和验证 | 标准的无状态认证方案 |
| bcryptjs | 密码加密 | 安全的密码哈希算法 |
| aws-sdk | AWS服务访问 | 访问DynamoDB |
| cors | 跨域支持 | 允许前后端分离部署 |
| dotenv | 环境变量管理 | 配置与代码分离 |

### 前端技术栈

| 技术 | 用途 | 选择理由 |
|------|------|----------|
| React | UI框架 | 组件化、声明式、生态完善 |
| Reactstrap | UI组件库 | 基于Bootstrap的React组件 |
| Axios | HTTP客户端 | 支持拦截器、Promise API |
| React Hooks | 状态管理 | 简化状态和副作用管理 |

### 数据库

| 技术 | 用途 | 选择理由 |
|------|------|----------|
| DynamoDB | NoSQL数据库 | 保持与原应用兼容、高性能 |

## 安全设计

### 1. 认证安全

- **密码加密**: 使用bcryptjs进行密码哈希，加盐强度为10
- **JWT令牌**: 
  - 有效期24小时，减少令牌被盗用的风险
  - 使用强密钥签名（建议使用至少32字符的随机字符串）
  - 在请求头中传输，避免URL泄露

### 2. 数据安全

- **用户数据隔离**: 所有查询都基于用户名进行过滤
- **DynamoDB加密**: 表级加密（SSE）保护静态数据

### 3. API安全

- **CORS配置**: 限制允许的源
- **输入验证**: 前后端双重验证
- **错误处理**: 不暴露敏感信息

### 建议的增强措施

1. 添加HTTPS支持
2. 实现请求频率限制（rate limiting）
3. 添加helmet中间件设置安全HTTP头
4. 实现CSRF防护
5. 日志审计

## 扩展性考虑

### 当前架构的优势

- ✅ 简单易懂，降低团队学习成本
- ✅ 快速部署，减少运维复杂度
- ✅ 统一的错误处理和日志记录
- ✅ 更低的延迟（无冷启动问题）

### 当前架构的限制

- ⚠️ 单点故障风险
- ⚠️ 垂直扩展受限
- ⚠️ 难以实现不同模块的独立扩展

### 扩展方案建议

#### 短期扩展（中小规模）
1. 使用PM2或Forever实现多进程
2. 添加Nginx做负载均衡
3. 实施缓存策略（Redis）

#### 长期扩展（大规模）
1. 考虑微服务改造
2. 使用容器化（Docker + Kubernetes）
3. 实施服务网格（Service Mesh）

## 代码组织原则

### 后端代码组织

```
backend/
├── config/         # 配置文件（数据库等）
├── middleware/     # 中间件（认证等）
├── routes/         # 路由定义
├── utils/          # 工具函数
└── server.js       # 应用入口
```

**设计原则**:
- 单一职责：每个模块只负责一个功能
- 关注点分离：配置、业务逻辑、数据访问分离
- 可测试性：便于单元测试

### 前端代码组织

```
frontend/src/
├── App.js          # 主应用组件
├── ToDo.js         # 待办事项组件
├── config.js       # 配置文件
└── *.css           # 样式文件
```

**设计原则**:
- 组件化：功能模块化
- Props传递：父子组件通信
- Hooks管理：状态和副作用

## 性能优化

### 已实现的优化

1. **前端性能**
   - 使用React的虚拟DOM减少重绘
   - 合理使用useEffect避免不必要的渲染

2. **后端性能**
   - Express中间件链简洁高效
   - DynamoDB查询使用索引

### 可改进的优化

1. **前端优化**
   - 代码分割（React.lazy）
   - 组件懒加载
   - 图片优化

2. **后端优化**
   - 实施API响应缓存
   - 数据库连接池
   - 压缩响应体（gzip）

3. **数据库优化**
   - 添加全局二级索引（GSI）
   - 批量操作API
   - 查询结果缓存

## 监控和调试

### 日志记录

当前使用console.log，建议升级为：
- 使用winston或pino等日志库
- 实施日志级别（error, warn, info, debug）
- 结构化日志输出
- 日志聚合（ELK Stack）

### 性能监控

建议添加：
- APM工具（如New Relic, DataDog）
- 自定义性能指标
- 健康检查端点
- 请求追踪

### 错误追踪

建议添加：
- Sentry等错误追踪服务
- 错误报警机制
- 错误分析面板

## 总结

这个单体架构适合：
- 中小型应用（日活 < 10万）
- 快速原型开发
- 团队规模 < 10人
- 预算有限的项目

随着业务增长，可以考虑：
1. 先进行垂直扩展（增加服务器配置）
2. 再进行水平扩展（增加服务器数量）
3. 最后考虑微服务改造（拆分为独立服务）

关键是在**简单性**和**扩展性**之间找到平衡点。

